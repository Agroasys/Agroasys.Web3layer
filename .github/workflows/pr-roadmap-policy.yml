name: PR Roadmap Policy

on:
  pull_request:
    types: [opened, reopened, synchronize, edited, milestoned, demilestoned]

jobs:
  enforce-roadmap-policy:
    name: enforce/pr-roadmap-policy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      repository-projects: read
    steps:
      - name: Enforce milestone + project association
        env:
          GH_TOKEN: ${{ github.token }}
          PROJECT_ID: ${{ vars.ROADMAP_PROJECT_ID }}
          PROJECT_TITLE: ${{ vars.ROADMAP_PROJECT_TITLE }}
          PR_NODE_ID: ${{ github.event.pull_request.node_id }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_MILESTONE: ${{ github.event.pull_request.milestone.title }}
          REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${PR_MILESTONE:-}" || "${PR_MILESTONE}" == "null" ]]; then
            echo "::error::Missing PR Milestone. Remediation: gh pr edit ${PR_NUMBER} --repo ${REPO} --milestone \"<Milestone Name>\""
            exit 1
          fi

          if [[ -z "${PROJECT_ID:-}" ]]; then
            echo "::error::Missing repository variable ROADMAP_PROJECT_ID (Project v2 node id)."
            echo "::error::Set ROADMAP_PROJECT_ID, then add the PR to the project."
            exit 1
          fi

          if [[ -z "${PROJECT_TITLE:-}" ]]; then
            PROJECT_TITLE="Agroasys.Web3layer Roadmap"
          fi

          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "::error::Missing github.token in workflow environment."
            exit 1
          fi

          query='query($prId:ID!){ node(id:$prId){ ... on PullRequest { projectItems(first:100){ nodes { project { id title url } } } } } }'
          if ! response="$(gh api graphql -f query="$query" -F prId="$PR_NODE_ID" 2>/tmp/pr_roadmap_err.log)"; then
            echo "::error::Unable to query Project items for this PR."
            echo "::error::Ensure workflow has 'repository-projects: read' permission and org policy allows Actions to read org projects."
            sed -n '1,80p' /tmp/pr_roadmap_err.log | sed 's/^/::error::/g'
            exit 1
          fi

          if ! jq -e --arg project_id "$PROJECT_ID" '.data.node.projectItems.nodes | map(.project.id) | index($project_id) != null' <<<"$response" >/dev/null; then
            project_query='query($projectId:ID!){ node(id:$projectId){ ... on ProjectV2 { items(first:100){ nodes { content { __typename ... on PullRequest { id } } } } } } }'
            project_response="$(gh api graphql -f query="$project_query" -F projectId="$PROJECT_ID" 2>/tmp/pr_roadmap_project_err.log || true)"
            if [[ -n "$project_response" ]] && jq -e --arg pr_id "$PR_NODE_ID" '.data.node.items.nodes | map(select(.content.__typename == "PullRequest") | .content.id) | index($pr_id) != null' <<<"$project_response" >/dev/null; then
              echo "Roadmap policy check passed for PR #${PR_NUMBER} (matched by project contents)"
              exit 0
            fi

            fallback_response="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json projectItems 2>/tmp/pr_roadmap_fallback_err.log || true)"
            if [[ -n "$fallback_response" ]] && jq -e --arg project_title "$PROJECT_TITLE" '.projectItems | map(.title) | index($project_title) != null' <<<"$fallback_response" >/dev/null; then
              echo "Roadmap policy check passed for PR #${PR_NUMBER} (matched by project title)"
              exit 0
            fi
            echo "::error::PR #${PR_NUMBER} is not added to required Project v2."
            echo "::error::Remediation:"
            echo "::error::  1) pr_id=\$(gh pr view ${PR_NUMBER} --repo ${REPO} --json id -q .id)"
            echo "::error::  2) gh api graphql -f query='mutation(\$project:ID!,\$content:ID!){ addProjectV2ItemById(input:{projectId:\$project,contentId:\$content}) { item { id } } }' -F project='${PROJECT_ID}' -F content=\"\$pr_id\""
            exit 1
          fi

          echo "Roadmap policy check passed for PR #${PR_NUMBER}"
