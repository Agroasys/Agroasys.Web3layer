services:
  postgres:
    image: postgres:16-alpine
    profiles: ["all", "infra"]
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: agroasys
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    profiles: ["all", "infra"]
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  indexer:
    image: node:20-alpine
    profiles: ["all", "indexer"]
    command:
      - node
      - -e
      - |
        const http = require('http');
        const payload = JSON.stringify({ data: { trades: [] } });

        http.createServer((req, res) => {
          if (req.url !== '/graphql' || req.method !== 'POST') {
            res.statusCode = 404;
            res.end('not found');
            return;
          }

          let body = '';
          req.on('data', (chunk) => {
            body += chunk;
          });

          req.on('end', () => {
            res.setHeader('Content-Type', 'application/json');
            res.end(payload);
          });
        }).listen(4350, '0.0.0.0');
    healthcheck:
      test:
        - CMD
        - node
        - -e
        - |
          fetch('http://127.0.0.1:4350/graphql', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: 'query { __typename }' }),
          })
            .then((response) => process.exit(response.ok ? 0 : 1))
            .catch(() => process.exit(1));
      interval: 10s
      timeout: 5s
      retries: 5

  ricardian:
    profiles: ["all", "ricardian"]
    build:
      context: .
      dockerfile: ricardian/Dockerfile
    environment:
      PORT: 3100
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: agroasys_ricardian
      DB_USER: postgres
      DB_PASSWORD: postgres
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "3100:3100"

  treasury:
    profiles: ["all", "treasury"]
    build:
      context: .
      dockerfile: treasury/Dockerfile
    environment:
      PORT: 3200
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: agroasys_treasury
      DB_USER: postgres
      DB_PASSWORD: postgres
      INDEXER_GRAPHQL_URL: http://indexer:4350/graphql
      TREASURY_INGEST_BATCH_SIZE: 100
      TREASURY_INGEST_MAX_EVENTS: 2000
    depends_on:
      postgres:
        condition: service_healthy
      indexer:
        condition: service_healthy
    ports:
      - "3200:3200"

  reconciliation:
    profiles: ["all", "reconciliation"]
    build:
      context: .
      dockerfile: reconciliation/Dockerfile
    environment:
      RECONCILIATION_ENABLED: true
      RECONCILIATION_DAEMON_INTERVAL_MS: 60000
      RECONCILIATION_BATCH_SIZE: 100
      RECONCILIATION_MAX_TRADES_PER_RUN: 1000
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: agroasys_reconciliation
      DB_USER: postgres
      DB_PASSWORD: postgres
      # Required startup dependency: must point to a reachable JSON-RPC endpoint.
      # Default assumes local host RPC is available on port 8545.
      RPC_URL: http://host.docker.internal:8545
      CHAIN_ID: 31337
      ESCROW_ADDRESS: "0x0000000000000000000000000000000000000000"
      USDC_ADDRESS: "0x0000000000000000000000000000000000000000"
      INDEXER_GRAPHQL_URL: http://indexer:4350/graphql
      NOTIFICATIONS_ENABLED: false
      NOTIFICATIONS_WEBHOOK_URL: ""
      NOTIFICATIONS_COOLDOWN_MS: 300000
      NOTIFICATIONS_REQUEST_TIMEOUT_MS: 5000
    depends_on:
      postgres:
        condition: service_healthy
      indexer:
        condition: service_healthy

volumes:
  postgres-data:
  redis-data:
