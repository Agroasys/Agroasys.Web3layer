import dotenv from 'dotenv';
import { strict as assert } from 'assert';
import { OracleConfig } from './types';

dotenv.config();

function validateEnv(name: string): string {
    const value = process.env[name];
    assert(value, `${name} is missing`);
    return value;
}

function validateEnvNumber(name: string, fallback?: number): number {
    const value = process.env[name];
    if ((value === undefined || value === '') && fallback !== undefined) {
        return fallback;
    }

    const required = value ?? validateEnv(name);
    const num = parseInt(required, 10);
    assert(!isNaN(num), `${name} must be a number`);
    return num;
}

function validateEnvBool(name: string, fallback: boolean): boolean {
    const value = process.env[name];

    if (!value) {
        return fallback;
    }

    return value.toLowerCase() === 'true';
}

export function loadConfig(): OracleConfig {
    try {
        const notificationsEnabled = validateEnvBool('NOTIFICATIONS_ENABLED', false);
        const notificationsWebhookUrl = process.env.NOTIFICATIONS_WEBHOOK_URL;
        const indexerGraphqlTimeoutMinMs = validateEnvNumber('INDEXER_GQL_TIMEOUT_MIN_MS', 1000);
        const indexerGraphqlTimeoutMaxMs = validateEnvNumber('INDEXER_GQL_TIMEOUT_MAX_MS', 60000);
        const indexerGraphqlRequestTimeoutMs = validateEnvNumber('INDEXER_GQL_TIMEOUT_MS', 10000);
        const retryAttempts = validateEnvNumber('RETRY_ATTEMPTS', 3);
        const retryDelay = validateEnvNumber('RETRY_DELAY', 1000);
        const hmacNonceTtlSeconds = validateEnvNumber('HMAC_NONCE_TTL_SECONDS', 600);
        const manualApprovalEnabled = validateEnvBool('MANUAL_APPROVAL_ENABLED', false);

        if (notificationsEnabled) {
            assert(notificationsWebhookUrl, 'NOTIFICATIONS_WEBHOOK_URL is required when NOTIFICATIONS_ENABLED=true');
        }

        assert(indexerGraphqlTimeoutMinMs >= 1000, 'INDEXER_GQL_TIMEOUT_MIN_MS must be >= 1000');
        assert(indexerGraphqlTimeoutMaxMs <= 60000, 'INDEXER_GQL_TIMEOUT_MAX_MS must be <= 60000');
        assert(
            indexerGraphqlTimeoutMinMs <= indexerGraphqlTimeoutMaxMs,
            'INDEXER_GQL_TIMEOUT_MIN_MS must be <= INDEXER_GQL_TIMEOUT_MAX_MS',
        );
        assert(
            indexerGraphqlRequestTimeoutMs >= indexerGraphqlTimeoutMinMs &&
            indexerGraphqlRequestTimeoutMs <= indexerGraphqlTimeoutMaxMs,
            `INDEXER_GQL_TIMEOUT_MS must be between ${indexerGraphqlTimeoutMinMs} and ${indexerGraphqlTimeoutMaxMs}`,
        );

        const config: OracleConfig = {
            // server
            port: validateEnvNumber('PORT'),
            apiKey: validateEnv('API_KEY'),
            hmacSecret: validateEnv('HMAC_SECRET'),
            
            // network
            rpcUrl: validateEnv('RPC_URL'),
            chainId: validateEnvNumber('CHAIN_ID'),
            escrowAddress: validateEnv('ESCROW_ADDRESS').toLowerCase(),
            usdcAddress: validateEnv('USDC_ADDRESS').toLowerCase(),
            oraclePrivateKey: validateEnv('ORACLE_PRIVATE_KEY'),
            
            // oracle db
            dbHost: validateEnv('DB_HOST'),
            dbPort: validateEnvNumber('DB_PORT'),
            dbName: validateEnv('DB_NAME'),
            dbUser: validateEnv('DB_USER'),
            dbPassword: validateEnv('DB_PASSWORD'),
            
            // indexer graphql api
            indexerGraphqlUrl: validateEnv('INDEXER_GRAPHQL_URL'),
            indexerGraphqlRequestTimeoutMs,
            
            // retry
            retryAttempts,
            retryDelay,
            hmacNonceTtlSeconds,

            // notifications
            notificationsEnabled,
            notificationsWebhookUrl,
            notificationsCooldownMs: validateEnvNumber('NOTIFICATIONS_COOLDOWN_MS', 300000),
            notificationsRequestTimeoutMs: validateEnvNumber('NOTIFICATIONS_REQUEST_TIMEOUT_MS', 5000),
            manualApprovalEnabled:manualApprovalEnabled
        };

        assert(config.retryAttempts >= 0 && config.retryAttempts <= 10, 'RETRY_ATTEMPTS must be between 0 and 10');
        assert(config.retryDelay >= 100 && config.retryDelay <= 30000, 'RETRY_DELAY must be between 100 and 30000');
        assert(config.hmacNonceTtlSeconds >= 60 && config.hmacNonceTtlSeconds <= 3600, 'HMAC_NONCE_TTL_SECONDS must be between 60 and 3600');
        assert(config.notificationsCooldownMs >= 0, 'NOTIFICATIONS_COOLDOWN_MS must be >= 0');
        assert(config.notificationsRequestTimeoutMs >= 1000, 'NOTIFICATIONS_REQUEST_TIMEOUT_MS must be >= 1000');
        
        return config;
    } catch (error) {
        console.error(JSON.stringify({ level: 'error', message: 'Oracle config validation failed', error: error instanceof Error ? error.message : String(error), service: 'oracle', env: process.env.NODE_ENV || 'development' }));
        process.exit(1);
    }
}

export const config = loadConfig();
